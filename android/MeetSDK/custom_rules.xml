<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules" default="release">
	<!-- rename output jar-->
	<!--property name="out.library.jar.file" location="${out.absolute.dir}/${ant.project.name}.jar" /-->
	
	<property name="SdkName" value="meet_sdk" />
	
	<property name="src.dir" location="src" />
	
	<property name="obj.dir" location="obj" />
	<property name="libs.dir" location="libs" />
	
	<property name="output.dir" location="output" />
	<property name="symbol.dir" location="syms" />
	<property name="dist.dir" location="dist" />
	
	<tstamp>
		<format property="build.timestamp" pattern="yyyyMMddHHmm" />
	</tstamp>
	<condition property="sdk.version" value="${Version}" else="${build.timestamp}">
		<isset property="Version" />
	</condition>

	<target name="gen_version">
		<condition property="config.sdk.version" value="${sdk.version}" else="${sdk.version}_debug" >
			<isfalse value="${debug}" />
		</condition>
		
		<condition property="config.startp2p" value="true" else="false">
			<and>
				<isset property="StartP2P" />
				<equals arg1="${StartP2P}" arg2="true" casesensitive="false" trim="true" />
			</and>
		</condition>
		
		<copy file="${src.dir}/android/pplive/media/config/Config.java.template" tofile="${src.dir}/android/pplive/media/config/Config.java" filtering="true" overwrite="true">
			<filterset>
				<filter token="CONFIG.SDK.VERSION" value="${config.sdk.version}" />
				<filter token="CONFIG.STARTP2P" value="${config.startp2p}"/>
			</filterset>
		</copy>
	</target>
	
	<target name="-symbol">
		<mkdir dir="${symbol.dir}" />
		<copy todir="${symbol.dir}/armeabi" overwrite="true" verbose="true">
			<fileset dir="${obj.dir}/local/armeabi">
				<filename name="**/*.so" />
			</fileset>
		</copy>
		<copy todir="${symbol.dir}/x86" overwrite="true" verbose="true">
			<fileset dir="${obj.dir}/local/x86">
				<filename name="**/*.so" />
			</fileset>
		</copy>
		<zip destfile="${dist.dir}/${SdkName}_symbol_${sdk.version}.zip" basedir="${symbol.dir}"/>
	</target>
	
	<target name="-pre-build" depends="gen_version,-ndk-build"> 
	</target> 
	
	<target name="-ndk-build"> 
		<condition property="ndk-build-command" value="${NDK_HOME}/ndk-build.cmd" else="ndk-build">
			<os family="windows" />
		</condition>
		
		<exec executable="${ndk-build-command}" failonerror="true"> 
			<arg value="clean" /> 
		</exec> 
		<exec executable="${ndk-build-command}" failonerror="true" /> 
	</target>
	
	<target name="-post-build" depends="-symbol">
		<mkdir dir="${output.dir}" />
		<copy 
			file="${out.absolute.dir}/classes.jar" 
			tofile="${output.dir}/${ant.project.name}.jar" 
			filtering="true" 
			overwrite="true" >
		</copy>
		<copy todir="${output.dir}/libs" overwrite="true" verbose="true">
			<fileset dir="${libs.dir}">
				<filename name="**/*.so" />
			</fileset>
		</copy>
		<zip destfile="${dist.dir}/${SdkName}_release_${sdk.version}.zip" basedir="${output.dir}" />
	</target>
	
	<target name="-pre-clean" >
		<delete dir="${obj.dir}" />
		<delete dir="${libs.dir}" />
		<delete dir="${output.dir}" />
		<delete dir="${symbol.dir}" />
	</target>
</project>